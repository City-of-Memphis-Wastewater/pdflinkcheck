# .github/workflows/microsoftstore.yml

name: Build and Publish MSIX to Microsoft Store

on:
  release:
    types: [published]
  push:
    branches: [main, dev]

jobs:
  build-msix:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: pip install uv

      - name: Ensure updated copies of packaged data files
        run: python src/pdflinkcheck/datacopy.py

      - name: Create venv and install project with extras
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |

          python -m venv .venv
          .\.venv\Scripts\python.exe -m pip install --upgrade pip 
          .\.venv\Scripts\python.exe -m pip install -e ".[full]"
          .\.venv\Scripts\python.exe -m pip install pyinstaller

      - name: Build EXE with PyInstaller
        id: build_exe
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          $env:PATH = "$env:GITHUB_WORKSPACE\.venv\Scripts;$env:PATH"
          $script = Join-Path $env:GITHUB_WORKSPACE "build_executable.py"
          $output = .\.venv\Scripts\python.exe $script 2>&1 | Tee-Object -Variable log
          Write-Host "$log"

          if ($log -match "Executable is located at:\s*(.+\.exe)") {
              $exePath = $matches[1].Trim()
              Write-Host "Detected EXE path: $exePath"
              "EXE_PATH=$exePath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

          } else {
              Write-Error "Could not detect EXE path from PyInstaller output"
              exit 1
          }

      - name: Debug EXE_PATH output
        shell: pwsh
        run: |
          Write-Host "EXE_PATH from outputs:"
          Write-Host "${{ steps.build_exe.outputs.EXE_PATH }}"


      - name: Debug, list dist folder, after PyInstaller
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          Write-Host "=== Listing  dist/ contents ==="
          Get-ChildItem dist -Recurse -File | Select-Object FullName
      
      - name: Rename EXE to stable name
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          $src = "${{ steps.build_exe.outputs.EXE_PATH }}"
          $dst = Join-Path "dist" "pdflinkcheck.exe"
          Move-Item -Force $src $dst
              
      - name: Prepare MSIX folder structure
        run: |
          copy dist\pdflinkcheck.exe msix\

      - name: Debug, list msix folder, after copying EXE
        shell: pwsh
        working-directory: ${{ github.workspace }}
        run: |
          Write-Host "=== Listing  msix/ contents ==="
          Get-ChildItem msix -Recurse -File | Select-Object FullName

      - name: Decode signing certificate
        shell: pwsh
        run: |
          $bytes = [System.Convert]::FromBase64String("${{ secrets.CERT_PFX }}")
          [IO.File]::WriteAllBytes("cert.pfx", $bytes)

      - name: Find makeappx
        id: find_makeappx
        shell: pwsh
        run: |
          $path = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin\" -Recurse -Filter makeappx.exe |
                  Where-Object { $_.FullName -match '\\x64\\' } |
                  Select-Object -First 1 -ExpandProperty FullName
          Write-Host "Found makeappx at: $path"
          echo "MAKEAPPX=$path" >> $env:GITHUB_OUTPUT

      - name: Create MSIX package
        shell: pwsh
        run: |
          & "${{ steps.find_makeappx.outputs.MAKEAPPX }}" pack /d msix /p pdflinkcheck.msix


      - name: Create MSIX package
        shell: pwsh
        run: |
          & "${{ steps.find_makeappx.outputs.MAKEAPPX }}" pack /d msix /p pdflinkcheck.msix
      
      
      - name: Find signtool
        id: find_signtool
        shell: pwsh
        run: |
          $path = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin\" -Recurse -Filter signtool.exe |
                  Where-Object { $_.FullName -match '\\x64\\' } |
                  Select-Object -First 1 -ExpandProperty FullName
          echo "SIGNTOOL=$path" >> $env:GITHUB_OUTPUT

          
      - name: Sign MSIX package
        shell: pwsh
        run: |
          & "${{ steps.find_signtool.outputs.SIGNTOOL }}" sign /a /f cert.pfx /p "${{ secrets.CERT_PASSWORD }}" pdflinkcheck.msix

      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: msix
          path: pdflinkcheck.msix
#  
#  publish-to-store:
#    needs: build-msix
#    runs-on: windows-latest
#
#    steps:
#      - name: Download MSIX artifact
#        uses: actions/download-artifact@v4
#        with:
#          name: msix
#
#      - name: Publish to Microsoft Store
#        run: |
#          curl -X POST `
#            -H "Authorization: Bearer ${{ secrets.STORE_CLIENT_SECRET }}" `
#            -F "package=@pdflinkcheck.msix" `
#            "https://manage.devcenter.microsoft.com/v1.0/my/applications/<YOUR-APP-ID>/submissions"
