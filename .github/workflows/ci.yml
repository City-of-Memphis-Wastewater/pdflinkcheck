# .github/workflows/ci.yml
# This workflow ensures pdflinkcheck installs and passes tests across supported Python versions.
# Focuses on UV (ultra-fast dependency management) for speed and reliability.

name: CI - Test & Lint

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  test_and_lint:
    # Use Ubuntu for CI testing
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # Test the minimum supported version and the current stable versions
        python-version: ['3.10', '3.11', '3.12'] # Note: 3.8/3.9 are dropped for modern tooling compatibility if possible

    steps:
    - uses: actions/checkout@v4
      with:
        # Fetch depth 0 is good practice for versioning/tagging, though optional
        fetch-depth: 0 

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install UV (The modern Python package manager)
      # UV is significantly faster than pip/poetry for CI builds
      run: pip install uv

    - name: Sync/Install Dependencies
      # Install the project and its dependencies (including dev dependencies for testing/linting)
      # This ensures PyMuPDF and all native dependencies resolve correctly.
      run: uv sync

    # --- Quality Gates ---
    
    # 1. Linting (e.g., using Ruff)
    #- name: Lint with ruff
    #  # Assumes ruff is included in your dev dependencies in pyproject.toml
    #  run: uv run ruff check .

    # 2. Testing (e.g., using pytest)
    - name: Run tests with pytest
      # Use uv run to execute pytest from the installed environment
      # Optional: Add coverage reporting if you have coverage installed
      run: uv run pytest tests/ -v
      
    # --- Optional: Build Sanity Check (Confirm the wheel can be built) ---
    
    - name: Build Wheel Sanity Check
      # We only check if the wheel build starts and finishes successfully.
      # This confirms the project metadata and setuptools configuration are valid.
      run: uv run python -m build --wheel --outdir dist