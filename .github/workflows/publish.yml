# File: .github/workflows/publish.yml

name: Check and Publish Python Package to PyPI and Releases

# This workflow is triggered when a new Release is created and published on GitHub.
on:
  release:
    types: [published]

jobs:
  pypi-publish:
    name: Upload release to PyPI
    runs-on: ubuntu-latest

    # RECOMMENDED: Use a deployment environment for security hardening.
    environment: pypi
    
    # IMPORTANT: Permissions for PyPI Trusted Publishing (OIDC).
    permissions:
      id-token: write  # Needed for OIDC authentication
      contents: read   # Needed to check out the code

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetches all history and tags for version determination
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      #- name: Install Hatch
      #  run: pip install hatch
      # --- UV-BASED INSTALLATION AND SETUP ---
      - name: Install uv
        # Install uv globally (or add it to the path)
        run: pip install uv

      - name: Ensure updated copies of packaged data files
        run: python src/pdflinkcheck/datacopy.py

      - name: Create isolated environment and install build dependencies
        # Use uv to install `build` and all dependencies specified in `pyproject.toml`
        # We don't need a separate lockfile step, as uv handles resolution quickly.
        # run: uv venv && source .venv/bin/activate && uv pip install --upgrade pip build .
        run: uv venv && source .venv/bin/activate && uv pip install --upgrade pip build ".[pdfium,mupdf]"
        # NOTE: `uv pip install .` installs the package itself and its dependencies
        # The `source .venv/bin/activate` is necessary for the next steps to use the venv's commands.

      # --- PACKAGE BUILD AND TEST ---

      - name: Build S-Dist and Wheel
        # This command uses the `build` package installed in the VENV to create package files.
        #run: source .venv/bin/activate && python -m build
        run: hatchling build
        
      - name: Run sanity check (using the installed package)
        # Use the global `uv run` if you don't want to activate, but since we activated above:
        run: |
          source .venv/bin/activate
          pip uninstall -y pdflinkcheck || true
          pip install dist/pdflinkcheck-*.whl
          # Use project's installed CLI command
          pdflinkcheck analyze --help
      # Optional: Also test the sdist (extra safety)
      - name: Sanity check the built sdist
        run: |
          source .venv/bin/activate
          pip uninstall -y pdflinkcheck || true
          pip install dist/pdflinkcheck-*.tar.gz
          pdflinkcheck analyze --help
      # --- PUBLISH ---
      - name: Publish package distributions to PyPI
        # This action uses the OIDC token to securely authenticate and upload.
        uses: pypa/gh-action-pypi-publish@release/v1
        # No username or password/token is needed for Trusted Publishing!
